<% provide(:title, @user.name) %>
<% provide(:button_text, '申請する')%>

<div>
	<table class="table table-bordered table-condensed user-table">
		<% if current_user.admin? %>
			<tr>
				<td>
					<%= link_to "⇦", user_path(date: @first_day.prev_month), class: "btn btn-primary" %>
					【<%= l(@first_day, format: :middle) %>】勤怠管理表
					<%= link_to "⇨", user_path(date: @first_day.next_month), class: "btn btn-primary" %>
					</td>
				<td>
					指定勤務開始時間<br/>
					指定勤務終了時間
					</td>
				<td colspan="3">基本時間</td>
				<td>初日:<%= l(@first_day, format: :short) %></td>
			</tr>
			
			<tr>
				<td>所属:<%= @user.affiliation %></td>
				<td>氏名:  <%= @user.name %></td>
				<td colspan="2">コード<%= @user.employee_number %></td>
				<td>出勤日数:<%= @worked_sum %></td>
				<td>月末日<%= l(@last_day, format: :short) %></td>
			</tr>
		<% else %>
			
			<tr>
				<td>
					<%= link_to "⇦", user_path(date: @first_day.prev_month), class: "btn btn-primary" %>
					【<%= l(@first_day, format: :middle) %>】勤怠管理表
					<%= link_to "⇨", user_path(date: @first_day.next_month), class: "btn btn-primary" %>
					</td>
				<td>
					指定勤務開始時間:<%= format_basic_info(@user.designed_work_start_time ) %><br/>
					指定勤務終了時間:<%= format_basic_info(@user.designed_work_finish_time ) %>
					</td>
				<td colspan="3">基本時間:<%= format_basic_info(@user. basic_time) %></td>
				<td>初日:<%= l(@first_day, format: :short) %></td>
			</tr>
			
			<tr>
				<td>所属:<%= @user.department.present? ? @user.department : "テスター"%></td>
				<td>氏名:  <%= @user.name %></td>
				<td>コード</td>
				<td>5555</td>
				<td>出勤日数:<%= @worked_sum %></td>
				<td>月末日<%= l(@last_day, format: :short) %></td>
			</tr>
		<% end %>
	</table>
</div>

<div class="btn-users-show">
	<!--所長承認のお知らせ条件分岐-->
	<% @all_attendances.each do |a| %>
		<% if a.request_one_month.present? %>
			<% if a.request_one_month == current_user.name %>
				<% @link_to = 1 %>
				<% @request_boss = @request_boss + 1 %>
		 	<% end %>
		<% end %>
	<% end %>
	<% if @link_to == 1 %>
		<p><%= link_to "【所長承認のお知らせ】", attendances_attendance_confirmation_user_path(@attendance) %>
			 <%= "#{@request_boss}件の通知があります。" %>
		</p>
		<% else %>
			<p>【所長承認のお知らせ】</p>
	<% end %>
	
	<!--勤怠変更申請のお知らせ条件分岐-->
	<% if @attendance.present? %>
		<p><%= link_to "【勤怠変更申請のお知らせ】" %></p>
		<% else %>
			<p>【勤怠変更申請のお知らせ】</p>
	<% end %>
	
	<!--残業申請条件分岐-->
	<% @all_attendances.each do |i| %>
		<% if i.finish_time.present? && i.mark_by_instructor.nil? %>
			<% if i.mark_of_instructor == current_user.name %>
				<% @link_to = 1 %>
				<% @overtime_sum = @overtime_sum + 1 %>
			 <% end %>	
		<% end %>
	<% end %>
	<% if @link_to == 1 %>
		<p><%= link_to "【残業申請のお知らせ】", attendances_overtime_confirmation_user_path(@attendance) %>
			 <%= "#{@overtime_sum}件の通知があります。" %>
		</p>
		<% else %>
			<p>【残業申請のお知らせ】</p>
	<% end %>
  
	<%= link_to "勤怠を変更", attendances_edit_one_month_user_path, class: "btn btn-primary btn-attendance" %>
	<%= link_to "CSV出力", "#", class: "btn btn-primary btn-attendance" %><br/>
	<%= link_to "勤怠修正ログ（承認済み）", "#", class: "btn btn-primary btn-attendance" %>
</div>

<div>
	<table class="table table-bordered table-condensed table-hover" id="table-attendances">
		<thead>
			<tr>
				 <!--rowspan:縦結合、colspan：横結合-->
				<th rowspan="3">残業申請</th>
				<th rowspan="3">日付</th>
				<th rowspan="3">曜日</th>
				<th colspan="8">【実績】</th>
				<th colspan="5">所定外勤務</th>
			</tr>
			<tr>
				<th colspan="3">出社</th>
				<th colspan="3">退社</th>
				<th rowspan="2">在社時間</th>
				<th rowspan="2">備考</th>
				<th colspan="2">終了予定時間</th>
				<th rowspan="2">時間外時間</th>
				<th rowspan="2">業務処理内容</th>
				<th rowspan="2">指示者確認</th>
			</tr>
			<tr>
				<th>時</th>
				<th>分</th>
				<th></th>
				<th>時</th>
				<th>分</th>
				<th></th>
				<th>時</th>
				<th>分</th>
			</tr>
		</thead>
		
		<tbody>
			<% @attendances.each do |day| %>
			<% css_class = case $days_of_the_week[day.worked_on.wday]
					when '土'
						'text-primary'
					when '日'
						'text-danger'
					end %>
				<tr>
					<td><%= link_to "残業申請", attendances_overtime_user_path(@user, date: day.worked_on), remote: true, class: "btn btn-primary" %></td>
					<td><%= l(day.worked_on, format: :short) %></td>
					<td class="<%= css_class %>"><%= $days_of_the_week[day.worked_on.wday]%></td>
					<td><%= l(day.started_at, format: :hour) if day.started_at.present? %></td>
					<td><%= l(day.started_at.floor_to(15.minutes), format: :minute) if day.started_at.present? %></td>
					<td>
						<% if (Date.current == day.worked_on) && day.started_at.nil?  %>
							<%= link_to "出勤", user_attendance_path(@user, day), method: :patch, class: "btn btn-primary btn-attenndance" %>
						<% end %>
					</td>
					<td><%= l(day.finished_at, format: :hour) if day.finished_at.present? %></td>
					<td><%= l(day.finished_at.floor_to(15.minutes), format: :minute) if day.finished_at.present? %></td>
					<td>
						<% if (Date.current == day.worked_on) && day.finished_at.nil? && day.started_at.present? %>
							<%= link_to "退勤", user_attendance_path(@user, day), method: :patch, class: "btn btn-primary btn-attenndance" %>
						<% end %>
					</td>
					<td>
						<% if day.started_at.present? && day.finished_at.present? %>
							<%= str_times = working_times(day.started_at, day.finished_at) %>
							<% @total_working_times = @total_working_times.to_f + str_times.to_f %>
						<% end %>
					</td>
					<td><%= day.note %></td>
					<td><%= l(day.finish_time, format: :hour) if day.finish_time.present? %></td>
					<td><%= l(day.finish_time.floor_to(15.minutes), format: :minute) if day.finish_time.present? %></td>
					<td>
						<% if day.finished_at.present? && day.finish_time.present? %>
							<%= over_times = over_working_times(@user.designed_work_finish_time, day.finish_time) %>
						<% end %>
					</td>
					<td><%= day.work_contents %></td>
					<td><%= day.mark_by_instructor %></td>
				</tr>
			<% end %>  
		</tbody>
		
		
		<%= form_with(model:@user, url: attendances_request_one_month_user_path(@attendances), local: true, method: :patch) do |f| %>
			<%= f.fields_for 'attendances[]', @attendance do |one_month| %>

			<tfoot>
			<tr>
				<!--rowspan:縦結合、colspan：横結合-->
				<td></td>
				<td colspan="2"></td>
				<td colspan="6"></td>
				<td><%= format("%.2f", @total_working_times.to_f) %></td>
				<td colspan="5"></td>
				<td>
					<% if @attendance.approval_by_boss.nil? %>
						<p>所長承認：未</p>
					<% end %>
					<p><%= one_month.select :request_one_month, @instructor %></p>
						 <%= f.submit yield(:button_text),class: "btn btn-lg btn-primary" %>
				</td>
			</tr>
		</tfoot>  
		<% end %>
		<% end %>
	</table>
</div>

<!--モーダル 表示-->
<div id="overtime" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true"></div>
<div id="overtime_confirmation" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true"></div>